steps:

- script: dotnet restore src/Owlvey.Falcon.API --configfile nuget/NuGet.Config
  displayName: Restore Dependencies

- script: dotnet build src/Owlvey.Falcon.API -c Release
  displayName: Build Projects

- script: dotnet test tests/Falcon.Falcon.UnitTests/Falcon.Falcon.UnitTests.csproj -c Release --no-build --no-restore /p:CollectCoverage=true /p:CoverletOutputFormat=opencover --logger trx;logfilename=result.xml
  displayName: Run Unit Tests

- script: dotnet test tests/Falcon.Falcon.ComponentTests/Owlvey.Falcon.ComponentTests.csproj -c Release --no-build --no-restore /p:CollectCoverage=true /p:CoverletOutputFormat=opencover --logger trx;logfilename=result.xml
  displayName: Run Component Tests

- script: dotnet test tests/Owlvey.Falcon.IntegrationTests/Owlvey.Falcon.IntegrationTests.csproj -c Release --no-build --no-restore /p:CollectCoverage=true /p:CoverletOutputFormat=opencover --logger trx;logfilename=result.xml
  displayName: Run Integration Tests

- script: dotnet publish src/Owlvey.Falcon.API -c Release --no-restore -o ../../artifactory
  displayName: Package Application

- task: PublishTestResults@2
  displayName: Unit Tests - Publish Test Results
  inputs:
    testRunner: VSTest
    testResultsFiles: 'tests/Owlvey.Falcon.UnitTests/TestResults/*.xml'
    testRunTitle: 'Owlvey Falcon - UnitTests'

- task: PublishTestResults@2
  displayName: Unit Tests - Publish Test Results
  inputs:
    testRunner: VSTest
    testResultsFiles: 'tests/Owlvey.Falcon.ComponentTests/TestResults/*.xml'
    testRunTitle: 'Owlvey Falcon - ComponentTests'

- task: PublishTestResults@2
  displayName: Integration Tests - Publish Test Results
  inputs:
    testRunner: VSTest
    testResultsFiles: 'tests/Owlvey.Falcon.IntegrationTests/TestResults/*.xml'
    testRunTitle: 'Owlvey Falcon - IntegrationTests'

- task: Docker@2
  displayName: buildAndPush
  inputs:
    containerRegistry: 'Owlvey Docker Connection'
    repository: owlvey/api
    Dockerfile: src/Owlvey.Falcon.API/Dockerfile
    buildContext: artifactory
    tags: |
     $(Build.BuildId)
     latest
